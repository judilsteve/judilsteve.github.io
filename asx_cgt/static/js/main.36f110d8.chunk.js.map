{"version":3,"sources":["hooks/useSharedState.js","sharedState.js","hooks/useAvailableParcels.js","hooks/useAllEventsOrdered.js","components/parcelList.jsx","components/select.jsx","components/adjustmentList.jsx","components/importExport.jsx","components/saleList.jsx","components/donateButton.jsx","App.jsx","index.js"],"names":["SharedPersistedState","localStorageKey","initialValue","persistedJson","window","localStorage","getItem","persistedData","JSON","parse","watch","s","setItem","stringify","this","value","watchers","watcher","push","length","index","splice","newValue","useSharedState","sharedState","useState","setValue","useEffect","watcherIndex","removeWatcher","parcels","adjustments","sales","processEvent","event","currentHoldings","errorOnMissingParcel","logs","type","perUnitCostBase","units","unitPrice","brokerage","id","date","memo","asxCode","remainingUnits","parcelId","eventId","log","toFixed","totalApplicableUnits","applicableParcelIds","applicableParcelId","parcel","Error","percentage","netAmount","applicableParcels","applicableParcel","unitsSold","getAvailableParcelsLookup","allEventsOrdered","eventIdToExclude","available","useAvailableParcels","useMemo","Object","values","filter","p","useAllEventsOrdered","sharedStateParcels","sharedStateAdjustments","sharedStateSales","orderBy","map","a","e","ParcelList","setParcels","orderedParcels","nextId","maxId","maxBy","undefined","charCodeBeforeCapitalA","charCodeAt","numericMaxId","pow","i","Math","numericNextId","modulo","String","fromCharCode","floor","newParcelActive","setNewParcelActive","lastRow","EditParcelRow","cancel","save","TableRow","TableCell","align","colSpan","IconButton","onClick","Add","parcelIdsBeingEdited","setParcelIdsBeingEdited","stopEditingParcel","id2","saveParcel","p2","detailParcelIds","setDetailParcelIds","TableContainer","component","Paper","Table","style","minWidth","size","TableHead","TableBody","includes","scope","dayjs","format","isDrp","ExpandLess","ExpandMore","Edit","Delete","ParcelDetailRow","props","getParcelLog","l","Typography","variant","color","setDate","setAsxCode","setIsDrp","setMemo","setUnits","setUnitPrice","setBrokerage","toString","unitsValid","isNaN","parseFloat","parseInt","unitPriceValid","brokerageValid","valid","disableToolbar","label","error","onChange","toJSON","TextField","target","FormControlLabel","control","Switch","checked","disabled","Done","Clear","Select","children","renderValue","multiple","FormControl","fullWidth","InputLabel","MenuProps","anchorOrigin","vertical","horizontal","transformOrigin","getContentAnchorEl","labelId","AdjustmentList","setAdjustments","orderedAdjustments","newAdjustmentActive","setNewAdjustmentActive","EditAdjustmentRow","adjustmentIdsBeingEdited","setAdjustmentIdsBeingEdited","stopEditingAdjustment","saveAdjustment","a2","errorLookup","lookup","adjustment","errors","availableParcels","detailAdjustmentIds","setDetailAdjustmentIds","Tooltip","title","Warning","join","adjustmentId","AdjustmentDetailRow","message","newCostBase","setApplicableParcelIds","setNetAmount","netAmountValid","allAvailableParcels","find","selected","MenuItem","Checkbox","ListItemText","primary","secondary","uuidv4","ImportExport","parcelsSharedState","adjustmentsSharedState","salesSharedState","setSales","setError","setMessage","importData","files","confirm","text","data","setTimeout","uploadRef","useRef","ref","accept","display","htmlFor","Button","current","click","jsonBlob","Blob","blobUrl","URL","createObjectURL","link","document","createElement","href","now","download","body","appendChild","dispatchEvent","MouseEvent","bubbles","cancelable","view","removeChild","margin","applyCgtDiscount","saleDate","parcelDate","cgtLiability","diff","calculateCgtLiability","sale","totalUnitsSold","parcelLiability","SaleList","ordered","decorations","currentParcel","unitsAvailable","orderedSales","saleDataLookup","newSaleActive","setNewSaleActive","EditSaleRow","saleIdsBeingEdited","setSaleIdsBeingEdited","stopEditingSale","saveSale","s2","detailSaleIds","setDetailSaleIds","saleId","SaleDetailRow","finalCostBase","capitalGains","unitsSoldLookup","setUnitsSoldLookup","newUnitsSoldLookup","availableParcelsLookup","unitsSoldValid","pid","parcelSaleIsValid","canCalculatePerUnitCgtLiabilities","perUnitCgtLiabilityLookup","floatUnitPrice","liability","orderedAvailableParcels","rebuildUnitsSoldLookup","useCallback","newApplicableParcelIds","ids","rowSpan","ApplicableParcel","perUnitCgtLiability","setUnitsSold","u","newUnitsSold","updateUnitsSold","soldFloat","soldInt","saleValid","helperText","DonateButton","action","method","name","src","border","alt","width","height","App","repoUrl","Container","maxWidth","ReactDOM","render","StrictMode","utils","DayjsUtils","getElementById"],"mappings":"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","file":"static/js/main.36f110d8.chunk.js","sourcesContent":["import { useEffect, useState } from 'react';\n\nexport class SharedState {\n    constructor(initialValue) {\n        this.value = initialValue;\n        this.watchers = [];\n    }\n\n    watch(watcher) {\n        this.watchers.push(watcher);\n        return this.watchers.length - 1;\n    }\n\n    removeWatcher(index) {\n        this.watchers.splice(index, 1);\n    }\n\n    setValue(newValue) {\n        this.value = newValue;\n        for(const watcher of this.watchers) {\n            watcher(newValue);\n        }\n    }\n}\n\nexport class SharedPersistedState extends SharedState {\n    constructor(localStorageKey, initialValue) {\n        const persistedJson = window.localStorage.getItem(localStorageKey);\n        const persistedData = persistedJson === null ? initialValue : JSON.parse(persistedJson);\n        super(persistedData);\n        this.watch(s => window.localStorage.setItem(localStorageKey, JSON.stringify(s)));\n    }\n}\n\nexport function useSharedState(sharedState) {\n    const [value, setValue] = useState(sharedState.value);\n    useEffect(() => {\n        const watcherIndex = sharedState.watch(setValue);\n        return () => sharedState.removeWatcher(watcherIndex);\n    }, [sharedState]);\n    return [value, newValue => sharedState.setValue(newValue)];\n}","import { SharedPersistedState } from './hooks/useSharedState';\n\nexport const parcels = new SharedPersistedState('parcels', []);\nexport const adjustments = new SharedPersistedState('adjustments', []);\nexport const sales = new SharedPersistedState('sales', []);","import { useMemo } from 'react';\n\nexport function processEvent(event, currentHoldings, errorOnMissingParcel, logs) {\n    switch(event.type) {\n        case 'ACQUISITION':\n            const perUnitCostBase = (event.units * event.unitPrice + event.brokerage) / event.units;\n            currentHoldings[event.id] = {\n                id: event.id,\n                date: event.date,\n                memo: event.memo,\n                asxCode: event.asxCode,\n                remainingUnits: event.units,\n                perUnitCostBase\n            };\n            logs?.push({\n                parcelId: event.id,\n                eventId: event.id,\n                date: event.date,\n                log: `Acquired Parcel ${event.id} with initial cost base of $${perUnitCostBase.toFixed(4)}/u.`\n            });\n            break;\n        case 'ADJUSTMENT':\n            let totalApplicableUnits = 0;\n            for(const applicableParcelId of event.applicableParcelIds) {\n                const parcel = currentHoldings[applicableParcelId];\n                if(!parcel || parcel.asxCode !== event.asxCode || parcel.remainingUnits <= 0) {\n                    if(errorOnMissingParcel)\n                        throw new Error(`Adjustment ${event.id} was applicable to invalid parcel ${applicableParcelId.toFixed(4)}`);\n                    else continue;\n                }\n                totalApplicableUnits += parcel.remainingUnits;\n            }\n            for(const applicableParcelId of event.applicableParcelIds) {\n                const parcel = currentHoldings[applicableParcelId];\n                if(!parcel) continue;\n                const percentage = parcel.remainingUnits / totalApplicableUnits * 100;\n                parcel.perUnitCostBase += event.netAmount / totalApplicableUnits;\n                logs?.push({\n                    parcelId: applicableParcelId,\n                    eventId: event.id,\n                    date: event.date,\n                    log: `Applied ${percentage.toFixed(2)}% of a $${event.netAmount} adjustment. New cost base: $${parcel.perUnitCostBase.toFixed(4)}/u.`\n                });\n            }\n            break;\n        case 'SALE':\n            for(const applicableParcel of event.applicableParcels) {\n                const parcel = currentHoldings[applicableParcel.id];\n                if(!parcel) {\n                    if(errorOnMissingParcel)\n                        throw new Error(`Sale ${event.id} was applicable to non-existent parcel ${applicableParcel.id}`);\n                    else continue;\n                }\n                parcel.remainingUnits -= applicableParcel.unitsSold;\n                logs?.push({\n                    parcelId: parcel.id,\n                    eventId: event.id,\n                    date: event.date,\n                    log: `Sold ${applicableParcel.unitsSold} units. Remaining units: ${parcel.remainingUnits}`\n                });\n            }\n            break;\n        default:\n            throw new Error(`Unrecognised event type ${event.type}`);\n    }\n}\n\n// TODO_JU? Some sort of lazy memoised repository for this, to improve performance\nexport function getAvailableParcelsLookup(allEventsOrdered, date, errorOnMissingParcel, eventIdToExclude) {\n    const available = {};\n\n    for(const event of allEventsOrdered) {\n        if(event.id === eventIdToExclude) continue;\n        if(date !== null && event.date > date) break;\n        processEvent(event, available, errorOnMissingParcel);\n    }\n    return available;\n}\n\nexport function getParcelLog(allEventsOrdered) {\n    const available = {};\n    const logs = [];\n\n    for(const event of allEventsOrdered) {\n        processEvent(event, available, /*errorOnMissingParcel:*/false, logs);\n    }\n    return logs;\n}\n\nexport default function useAvailableParcels(allEventsOrdered, date, errorOnMissingParcel, eventIdToExclude) {\n    return useMemo(() => {\n        const available = getAvailableParcelsLookup(allEventsOrdered, date, errorOnMissingParcel, eventIdToExclude);\n        return Object.values(available).filter(p => p.remainingUnits > 0);\n    }, [allEventsOrdered, date, errorOnMissingParcel, eventIdToExclude]);\n}","import { useMemo } from 'react';\nimport { useSharedState } from './useSharedState';\nimport { parcels as sharedStateParcels, adjustments as sharedStateAdjustments, sales as sharedStateSales } from '../sharedState';\nimport { orderBy } from 'lodash-es';\n\nexport default function useAllEventsOrdered() {\n    const [parcels, ] = useSharedState(sharedStateParcels);\n    const [adjustments, ] = useSharedState(sharedStateAdjustments);\n    const [sales, ] = useSharedState(sharedStateSales);\n    return useMemo(() =>\n        orderBy([\n            ...parcels.map(p => ({ type: 'ACQUISITION', ...p })),\n            ...adjustments.map(a => ({ type: 'ADJUSTMENT', ...a })),\n            ...sales.map(s => ({ type: 'SALE', ...s })),\n        ], [\n            e => e.date,\n            // Tiebreaking logic:\n            // Acquisitions should be before sales, to make sure all parcels are available for sale\n            // Positive Adjustments should be after buys and before sales, to allow user to maximise cost base\n            // Negative Adjustments should be after sales, to maximise cost base\n            // BUY -> +ADJ -> SALE -> -ADJ\n            e =>\n                e.type === 'ACQUISITION' ? 1 :\n                (e.type === 'ADJUSTMENT' && e.netAmount > 0) ? 2 :\n                e.type === 'SALE' ? 3 :\n                4\n        ])\n    , [parcels, adjustments, sales]);\n}","import React, { useEffect, useMemo, useState, Fragment } from 'react';\nimport {\n    TableContainer,\n    Paper,\n    Table,\n    TableHead,\n    TableRow,\n    TableCell,\n    TableBody,\n    IconButton,\n    TextField,\n    FormControlLabel,\n    Switch,\n    Typography\n} from '@material-ui/core';\nimport {\n    Delete,\n    Add,\n    Done,\n    Clear,\n    Edit,\n    ExpandLess,\n    ExpandMore\n} from '@material-ui/icons';\nimport { KeyboardDatePicker } from \"@material-ui/pickers\";\nimport dayjs from 'dayjs';\nimport { useSharedState } from '../hooks/useSharedState';\nimport { parcels as sharedStateParcels } from '../sharedState';\nimport { maxBy, orderBy } from 'lodash-es';\nimport  { getParcelLog } from '../hooks/useAvailableParcels';\nimport useAllEventsOrdered from '../hooks/useAllEventsOrdered';\n\nexport default function ParcelList() {\n    const [parcels, setParcels] = useSharedState(sharedStateParcels);\n    const orderedParcels = useMemo(() => orderBy(parcels, p => p.date), [parcels]);\n\n    const nextId = useMemo(() => {\n        const maxId = maxBy(parcels, p => p.id)?.id;\n        if(maxId === undefined) return 'A';\n\n        const charCodeBeforeCapitalA = 'A'.charCodeAt(0) - 1;\n        let numericMaxId = 0;\n        let pow = 0;\n        for(let i = maxId.length - 1; i >= 0; i--) {\n            numericMaxId += (maxId.charCodeAt(i) - charCodeBeforeCapitalA) * Math.pow(26, pow++);\n        }\n\n        let numericNextId = numericMaxId + 1;\n        let nextId = '';\n        while (numericNextId)\n        {\n            const modulo = (numericNextId - 1) % 26;\n            nextId = String.fromCharCode(65 + modulo) + nextId;\n            numericNextId = Math.floor((numericNextId - modulo) / 26);\n        }\n\n        return nextId;\n    }, [parcels]);\n\n    const [newParcelActive, setNewParcelActive] = useState(false);\n    const saveNewParcel = p => {\n        setParcels([...parcels, p]);\n        setNewParcelActive(false);\n    }\n    const lastRow = newParcelActive ?\n        <EditParcelRow id={nextId} cancel={() => setNewParcelActive(false)} save={saveNewParcel}/> : \n        <TableRow>\n            <TableCell align=\"right\" colSpan={9}><IconButton onClick={() => setNewParcelActive(true)}><Add/></IconButton></TableCell>\n        </TableRow>\n\n    const [parcelIdsBeingEdited, setParcelIdsBeingEdited] = useState([]);\n    const editParcel = id => setParcelIdsBeingEdited([...parcelIdsBeingEdited, id]);\n    const stopEditingParcel = id => setParcelIdsBeingEdited(parcelIdsBeingEdited.filter(id2 => id2 !== id));\n    const saveParcel = p => {\n        setParcels([...parcels.filter(p2 => p2.id !== p.id), p]);\n        stopEditingParcel(p.id);\n    };\n\n    const [detailParcelIds, setDetailParcelIds] = useState([]);\n    const toggleDetails = parcelId => detailParcelIds.includes(parcelId) ?\n        setDetailParcelIds(detailParcelIds.filter(id => id !== parcelId)) :\n        setDetailParcelIds([...detailParcelIds, parcelId]);\n\n    return <TableContainer component={Paper}>\n        <Table style={{ minWidth: 650 }} size=\"small\">\n            <TableHead>\n                <TableRow>\n                    <TableCell>ID</TableCell>\n                    <TableCell align=\"right\">Date Acquired</TableCell>\n                    <TableCell align=\"right\">ASX Code</TableCell>\n                    <TableCell align=\"right\">Parcel Type</TableCell>\n                    <TableCell align=\"right\">Memo</TableCell>\n                    <TableCell align=\"right\">Units</TableCell>\n                    <TableCell align=\"right\">Unit Price ($/u)</TableCell>\n                    <TableCell align=\"right\">Brokerage ($)</TableCell>\n                    <TableCell align=\"right\">Actions</TableCell>\n                </TableRow>\n            </TableHead>\n            <TableBody>\n                {orderedParcels.map(p => parcelIdsBeingEdited.includes(p.id) ?\n                    <EditParcelRow key={p.id} id={p.id} parcel={p} cancel={() => stopEditingParcel(p.id)} save={saveParcel}/> :\n                    <Fragment key={p.id}>\n                        <TableRow key={p.id}>\n                            <TableCell component=\"th\" scope=\"row\">{p.id}</TableCell>\n                            <TableCell align=\"right\">{dayjs(p.date).format('YYYY-MM-DD')}</TableCell>\n                            <TableCell align=\"right\">{p.asxCode}</TableCell>\n                            <TableCell align=\"right\">{p.isDrp ? 'Dividend Reinvestment' : 'Purchase'}</TableCell>\n                            <TableCell align=\"right\">{p.memo}</TableCell>\n                            <TableCell align=\"right\">{p.units}</TableCell>\n                            <TableCell align=\"right\">{p.unitPrice}</TableCell>\n                            <TableCell align=\"right\">{p.brokerage}</TableCell>\n                            <TableCell align=\"right\">\n                                <IconButton size=\"small\" onClick={() => toggleDetails(p.id)}>{detailParcelIds.includes(p.id) ? <ExpandLess/> : <ExpandMore/>}</IconButton>\n                                <IconButton size=\"small\" onClick={() => editParcel(p.id)}><Edit/></IconButton>\n                                <IconButton size=\"small\" onClick={() => setParcels(parcels.filter(p2 => p2.id !== p.id))}><Delete/></IconButton>\n                            </TableCell>\n                        </TableRow>\n                        {detailParcelIds.includes(p.id) && <ParcelDetailRow parcelId={p.id}/>}\n                    </Fragment>\n                )}\n                {lastRow}\n            </TableBody>\n        </Table>\n    </TableContainer>\n}\n\nfunction ParcelDetailRow(props) {\n    const { parcelId } = props;\n\n    const allEventsOrdered = useAllEventsOrdered();\n    const log = useMemo(() =>\n        getParcelLog(allEventsOrdered).filter(l => l.parcelId === parcelId)\n    , [allEventsOrdered, parcelId]);\n\n    return <>\n        {log.map(e => <TableRow key={e.eventId}>\n            <TableCell/>\n            <TableCell align=\"right\"><Typography variant=\"body2\" color=\"primary\">\n                {dayjs(e.date).format('YYYY-MM-DD')}\n            </Typography></TableCell>\n            <TableCell colSpan={6} align=\"right\"><Typography variant=\"body2\" color=\"primary\">\n                {e.log}\n            </Typography></TableCell>\n            <TableCell/>\n        </TableRow>)}\n    </>\n}\n\nfunction EditParcelRow(props) {\n    const {\n        id,\n        save,\n        cancel,\n        parcel\n    } = props;\n\n    const [date, setDate] = useState(null);\n    const [asxCode, setAsxCode] = useState('');\n    const [isDrp, setIsDrp] = useState(false);\n    const [memo, setMemo] = useState('');\n    const [units, setUnits] = useState('');\n    const [unitPrice, setUnitPrice] = useState('');\n    const [brokerage, setBrokerage] = useState('');\n\n    useEffect(() => {\n        setDate(parcel?.date ?? null);\n        setAsxCode(parcel?.asxCode ?? '');\n        setIsDrp(parcel?.isDrp ?? false);\n        setMemo(parcel?.memo ?? '');\n        setUnits(parcel?.units.toString() ?? '');\n        setUnitPrice(parcel?.unitPrice.toString() ?? '');\n        setBrokerage(parcel?.brokerage.toString() ?? '');\n    }, [parcel]);\n\n    const boundSave = () => save({\n        id,\n        date,\n        asxCode,\n        isDrp,\n        memo,\n        units: parseInt(units),\n        unitPrice: parseFloat(unitPrice),\n        brokerage: isDrp ? 0 : parseFloat(brokerage)\n    });\n\n    const unitsValid = units && !isNaN(parseFloat(units)) && parseInt(units) === parseFloat(units);\n    const unitPriceValid = unitPrice && !isNaN(parseFloat(unitPrice));\n    const brokerageValid = isDrp || (brokerage && !isNaN(parseFloat(brokerage)));\n\n    const valid = date && asxCode && unitsValid && unitPriceValid && brokerageValid;\n\n    return <TableRow>\n        <TableCell component=\"th\" scope=\"row\">{id}</TableCell>\n        <TableCell align=\"right\">\n            <KeyboardDatePicker\n                disableToolbar\n                variant=\"inline\"\n                format=\"YYYY-MM-DD\"\n                label=\"Date\"\n                value={date}\n                error={!date}\n                onChange={e => setDate(e.toJSON())}\n            />\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField value={asxCode} onChange={e => setAsxCode(e.target.value)} error={!asxCode} label=\"ASX Code\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <FormControlLabel control={<Switch color=\"primary\" checked={isDrp} onChange={() => setIsDrp(!isDrp)}/>} label=\"Dividend Reinvestment\" />\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField value={memo} onChange={e => setMemo(e.target.value)} label=\"Memo\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField type=\"number\" value={units} onChange={e => setUnits(e.target.value)} error={!unitsValid} label=\"Units\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField type=\"number\" value={unitPrice} onChange={e => setUnitPrice(e.target.value)} error={!unitPriceValid} label=\"Unit Price ($/u)\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField type=\"number\" disabled={isDrp} value={isDrp ? '0.00' : brokerage} onChange={e => setBrokerage(e.target.value)} error={!isDrp && !brokerageValid} label=\"Brokerage ($)\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <IconButton onClick={boundSave} disabled={!valid}><Done/></IconButton>\n            <IconButton onClick={cancel}><Clear/></IconButton>\n        </TableCell>\n    </TableRow>\n}","import React from 'react';\nimport { FormControl, InputLabel, Select as MatSelect } from '@material-ui/core';\n\nexport default function Select(props) {\n    const {\n        disabled,\n        error,\n        value,\n        onChange,\n        children,\n        renderValue,\n        multiple,\n        id,\n        label\n    } = props;\n\n    // Renders popover *below* the dropdown instead of on top of it\n    const selectProps = {\n        anchorOrigin: {\n            vertical: 'bottom',\n            horizontal: 'left'\n        },\n        transformOrigin: {\n            vertical: 'top',\n            horizontal: 'left'\n        },\n        getContentAnchorEl: null\n    };\n\n    return <FormControl fullWidth>\n        <InputLabel id={id}>{label}</InputLabel>\n        <MatSelect\n            MenuProps={selectProps}\n            disabled={disabled}\n            labelId={id}\n            error={error}\n            multiple={multiple}\n            fullWidth\n            value={value}\n            onChange={onChange}\n            renderValue={renderValue}>\n            {children}\n        </MatSelect>\n    </FormControl>;\n}","import React, { useEffect, useMemo, useState, Fragment } from 'react';\nimport {\n    TableContainer,\n    Paper,\n    Table,\n    TableHead,\n    TableRow,\n    TableCell,\n    TableBody,\n    IconButton,\n    TextField,\n    MenuItem,\n    Checkbox,\n    ListItemText,\n    Tooltip,\n    Typography\n} from '@material-ui/core';\nimport {\n    Delete,\n    Add,\n    Done,\n    Clear,\n    Edit,\n    Warning,\n    ExpandLess,\n    ExpandMore\n} from '@material-ui/icons';\nimport { KeyboardDatePicker } from \"@material-ui/pickers\";\nimport dayjs from 'dayjs';\nimport Select from './select';\nimport useAvailableParcels, { getAvailableParcelsLookup } from '../hooks/useAvailableParcels';\nimport { useSharedState } from '../hooks/useSharedState';\nimport { adjustments as sharedStateAdjustments } from '../sharedState';\nimport { orderBy } from 'lodash-es';\nimport { v4 as uuidv4 } from 'uuid';\nimport useAllEventsOrdered from '../hooks/useAllEventsOrdered';\n\nexport default function AdjustmentList() {\n    const [adjustments, setAdjustments] = useSharedState(sharedStateAdjustments);\n    const orderedAdjustments = useMemo(() => orderBy(adjustments, a => a.date), [adjustments]);\n\n    const [newAdjustmentActive, setNewAdjustmentActive] = useState(false);\n    const saveNewAdjustment = a => {\n        setAdjustments([...adjustments, a]);\n        setNewAdjustmentActive(false);\n    }\n    const lastRow = newAdjustmentActive ?\n        <EditAdjustmentRow cancel={() => setNewAdjustmentActive(false)} save={saveNewAdjustment}/> : \n        <TableRow>\n            <TableCell align=\"right\" colSpan={7}><IconButton onClick={() => setNewAdjustmentActive(true)}><Add/></IconButton></TableCell>\n        </TableRow>\n\n    const [adjustmentIdsBeingEdited, setAdjustmentIdsBeingEdited] = useState([]);\n    const editAdjustment = id => setAdjustmentIdsBeingEdited([...adjustmentIdsBeingEdited, id]);\n    const stopEditingAdjustment = id => setAdjustmentIdsBeingEdited(adjustmentIdsBeingEdited.filter(id2 => id2 !== id));\n    const saveAdjustment = a => {\n        setAdjustments([...adjustments.filter(a2 => a2.id !== a.id), a]);\n        stopEditingAdjustment(a.id);\n    };\n\n    const allEventsOrdered = useAllEventsOrdered();\n\n    const errorLookup = useMemo(() => {\n        const lookup = {};\n        for(const adjustment of adjustments) {\n            const errors = [];\n            const availableParcels = getAvailableParcelsLookup(allEventsOrdered, adjustment.date, /*errorOnMissingParcel:*/false);\n            for(const parcelId of adjustment.applicableParcelIds) {\n                const parcel = availableParcels[parcelId];\n                if(parcel === undefined) {\n                    errors.push(`Parcel ${parcelId} did not exist at the adjustment date.`);\n                    continue;\n                } else if(parcel.asxCode !== adjustment.asxCode) {\n                    errors.push(`Parcel ${parcelId} has the wrong ASX Code.`);\n                } else if(parcel.remainingUnits <= 0) {\n                    errors.push(`Parcel ${parcelId} was entirely sold before the adjustment date.`);\n                }\n            }\n            lookup[adjustment.id] = errors;\n        }\n        return lookup;\n    }, [allEventsOrdered, adjustments]);\n\n    const [detailAdjustmentIds, setDetailAdjustmentIds] = useState([]);\n    const toggleDetails = adjustmentId => detailAdjustmentIds.includes(adjustmentId) ?\n        setDetailAdjustmentIds(detailAdjustmentIds.filter(id => id !== adjustmentId)) :\n        setDetailAdjustmentIds([...detailAdjustmentIds, adjustmentId]);\n\n    return <TableContainer component={Paper}>\n        <Table style={{ minWidth: 650 }} size=\"small\">\n            <TableHead>\n                <TableRow>\n                    <TableCell/>\n                    <TableCell align=\"right\">Date</TableCell>\n                    <TableCell align=\"right\">ASX Code</TableCell>\n                    <TableCell align=\"right\">Applicable Parcels</TableCell>\n                    <TableCell align=\"right\">Memo</TableCell>\n                    <TableCell align=\"right\">Net Amount ($)</TableCell>\n                    <TableCell align=\"right\">Actions</TableCell>\n                </TableRow>\n            </TableHead>\n            <TableBody>\n                {orderedAdjustments.map(a => adjustmentIdsBeingEdited.includes(a.id) ?\n                    <EditAdjustmentRow key={a.id} id={a.id} adjustment={a} cancel={() => stopEditingAdjustment(a.id)} save={saveAdjustment}/> :\n                    <Fragment key={a.id}>\n                        <TableRow>\n                            <TableCell>{ errorLookup[a.id].length ?\n                                errorLookup[a.id].map(e => <Tooltip key={e} title={e}>\n                                    <Warning color=\"error\"/>\n                                </Tooltip>) :\n                                <></> }\n                            </TableCell>\n                            <TableCell align=\"right\">{dayjs(a.date).format('YYYY-MM-DD')}</TableCell>\n                            <TableCell align=\"right\">{a.asxCode}</TableCell>\n                            <TableCell align=\"right\">{a.applicableParcelIds.join(', ')}</TableCell>\n                            <TableCell align=\"right\">{a.memo}</TableCell>\n                            <TableCell align=\"right\">{a.netAmount}</TableCell>\n                            <TableCell align=\"right\">\n                                <IconButton size=\"small\" onClick={() => toggleDetails(a.id)}>{detailAdjustmentIds.includes(a.id) ? <ExpandLess/> : <ExpandMore/>}</IconButton>\n                                <IconButton size=\"small\" onClick={() => editAdjustment(a.id)}><Edit/></IconButton>\n                                <IconButton size=\"small\" onClick={() => setAdjustments(adjustments.filter(a2 => a2.id !== a.id))}><Delete/></IconButton>\n                            </TableCell>\n                        </TableRow>\n                        {detailAdjustmentIds.includes(a.id) && <AdjustmentDetailRow adjustment={a}/>}\n                    </Fragment>\n                )}\n                {lastRow}\n            </TableBody>\n        </Table>\n    </TableContainer>\n}\n\nfunction AdjustmentDetailRow(props) {\n    const { adjustment } = props;\n\n    const allEventsOrdered = useAllEventsOrdered();\n    const log = useMemo(() => {\n        const available = getAvailableParcelsLookup(allEventsOrdered, adjustment.date, /*errorOnMisingParcel:*/false, adjustment.id );\n        const log = [];\n\n        let totalApplicableUnits = 0;\n        for(const applicableParcelId of adjustment.applicableParcelIds) {\n            const parcel = available[applicableParcelId];\n            if(!parcel || parcel.asxCode !== adjustment.asxCode || parcel.remainingUnits < 0) continue;\n            totalApplicableUnits += parcel.remainingUnits;\n        }\n        log.push(`Adjustment applies to a total of ${totalApplicableUnits} units.`);\n        for(const applicableParcelId of adjustment.applicableParcelIds) {\n            const parcel = available[applicableParcelId];\n            if(!parcel || parcel.asxCode !== adjustment.asxCode || parcel.remainingUnits < 0) continue;\n            const percentage = parcel.remainingUnits / totalApplicableUnits * 100;\n            let message = `${percentage.toFixed(2)}% of adjustment applied to parcel ${parcel.id} (${parcel.remainingUnits} remaining units). `;\n            const newCostBase = parcel.perUnitCostBase + adjustment.netAmount / totalApplicableUnits;\n            message += `Cost base of parcel was ${adjustment.netAmount > 0 ? 'raised' : 'lowered'} from $${parcel.perUnitCostBase.toFixed(4)}/u to $${newCostBase.toFixed(4)}/u.`;\n            log.push(message);\n        }\n        return log;\n    }, [allEventsOrdered, adjustment]);\n\n    return <>\n        {log.map(e => <TableRow key={e}>\n            <TableCell/>\n            <TableCell colSpan={5} align=\"right\"><Typography variant=\"body2\" color=\"primary\">\n                {e}\n            </Typography></TableCell>\n            <TableCell/>\n        </TableRow>)}\n    </>\n}\n\nfunction EditAdjustmentRow(props) {\n    const {\n        id,\n        save,\n        cancel,\n        adjustment\n    } = props;\n\n    const [date, setDate] = useState(null);\n    const [asxCode, setAsxCode] = useState(null);\n    const [applicableParcelIds, setApplicableParcelIds] = useState([]);\n    const [memo, setMemo] = useState('');\n    const [netAmount, setNetAmount] = useState('');\n\n    useEffect(() => {\n        setDate(adjustment?.date ?? null);\n        setAsxCode(adjustment?.asxCode ?? null);\n        setApplicableParcelIds(adjustment?.applicableParcelIds ?? []);\n        setMemo(adjustment?.memo ?? '');\n        setNetAmount(adjustment?.netAmount.toString() ?? '');\n    }, [adjustment]);\n\n    const boundSave = () => save({\n        id: id ?? uuidv4(),\n        date,\n        asxCode,\n        applicableParcelIds,\n        memo,\n        netAmount: parseFloat(netAmount)\n    });\n\n    const netAmountValid = netAmount && !isNaN(parseFloat(netAmount));\n    const valid = date && applicableParcelIds.length && netAmountValid;\n\n    const allAvailableParcels = useAvailableParcels(useAllEventsOrdered(), date, /*errorOnMissingParcel:*/false)\n    const availableParcels = useMemo(() => allAvailableParcels\n        .filter(p => !asxCode || p.asxCode === asxCode)\n    , [allAvailableParcels, asxCode]);\n\n    useEffect(() => {\n        setApplicableParcelIds(applicableParcelIds => applicableParcelIds\n            .filter(id => availableParcels.find(p =>\n                p.id === id && (!asxCode || p.asxCode === asxCode))));\n    }, [availableParcels, asxCode]);\n\n    return <TableRow>\n        <TableCell/>\n        <TableCell align=\"right\">\n            <KeyboardDatePicker\n                disableToolbar\n                variant=\"inline\"\n                format=\"YYYY-MM-DD\"\n                label=\"Date\"\n                value={date}\n                error={!date}\n                onChange={e => setDate(e.toJSON())}\n            />\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField value={asxCode} onChange={e => setAsxCode(e.target.value)} label=\"ASX Code\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <Select\n                disabled={!date || !availableParcels.length}\n                id=\"applicable-parcel-select\"\n                label=\"Applicable Parcels\"\n                error={!applicableParcelIds.length}\n                multiple\n                value={applicableParcelIds}\n                onChange={e => setApplicableParcelIds(e.target.value)}\n                renderValue={selected => selected.join(', ')}>\n                {availableParcels.map(p =>\n                    <MenuItem key={p.id} value={p.id}>\n                        <Checkbox checked={applicableParcelIds.includes(p.id)} />\n                        <ListItemText primary={`${p.id}${p.memo ? ': ' + p.memo : ''}`} secondary={`${p.remainingUnits}x ${p.asxCode}, acquired ${dayjs(p.date).format('YYYY-MM-DD')}`}/>\n                    </MenuItem>)}\n            </Select>\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField value={memo} onChange={e => setMemo(e.target.value)} label=\"Memo\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <TextField type=\"number\" value={netAmount} onChange={e => setNetAmount(e.target.value)} error={!netAmountValid} label=\"Net Amount ($)\"/>\n        </TableCell>\n        <TableCell align=\"right\">\n            <IconButton onClick={boundSave} disabled={!valid}><Done/></IconButton>\n            <IconButton onClick={cancel}><Clear/></IconButton>\n        </TableCell>\n    </TableRow>\n}","import { Button, Typography } from '@material-ui/core';\nimport React, { useRef, useState } from 'react';\nimport { useSharedState } from '../hooks/useSharedState';\nimport { parcels as parcelsSharedState, adjustments as adjustmentsSharedState, sales as salesSharedState } from '../sharedState';\nimport dayjs from 'dayjs';\n\nexport default function ImportExport() {\n    const [parcels, setParcels] = useSharedState(parcelsSharedState);\n    const [adjustments, setAdjustments] = useSharedState(adjustmentsSharedState);\n    const [sales, setSales] = useSharedState(salesSharedState);\n    const [error, setError] = useState(null);\n    const [message, setMessage] = useState(null);\n\n    const importData = async files => {\n        if(!window.confirm(`WARNING: Importing this file will completely and irreversibly replace any data currently entered. Continue?`)) return;\n\n        setError(null);\n        setMessage(null);\n\n        let data;\n        try {\n            data = JSON.parse(await files[0].text());\n        } catch(e) {\n            setError('File was not valid JSON. Ensure that you have selected the correct file and try again.');\n            throw e;\n        }\n        if(!data.parcels || !data.adjustments || !data.sales) {\n            setError('File appears malformed. Ensure that you have selected the correct file and try again.');\n            return;\n        }\n        // TODO_JU? Further schema validation\n\n        setParcels(data.parcels);\n        setAdjustments(data.adjustments);\n        setSales(data.sales);\n\n        setMessage('Import successful');\n        setTimeout(() => setMessage(null), 1000 * 30);\n    };\n\n    const exportData = () => {\n        const jsonBlob = new Blob([JSON.stringify({\n            parcels,\n            adjustments,\n            sales\n        })]);\n        const blobUrl = URL.createObjectURL(jsonBlob);\n        const link = document.createElement(\"a\");\n        link.href = blobUrl;\n        const now = dayjs();\n        link.download = `Holdings_${now.format(`YYYY-MM-DD_THH-mm-ss`)}.json`;\n        document.body.appendChild(link);\n        link.dispatchEvent( new MouseEvent('click', {\n            bubbles: true,\n            cancelable: true,\n            view: window\n        }));\n        document.body.removeChild(link);\n    };\n\n    const uploadRef = useRef(null);\n\n    return <>\n        <input\n            ref={uploadRef}\n            onChange={e => importData(e.target.files)}\n            accept=\"application/json\"\n            style={{ display: 'none' }}\n            id=\"import-file-input\"\n            type=\"file\"/>\n        <label htmlFor=\"import-file-input\">\n            <Button onClick={() => uploadRef.current?.click()} variant=\"contained\" color=\"primary\">Import Holdings</Button>\n        </label>\n        <Button onClick={exportData} style={{margin: 10}} variant=\"contained\" color=\"primary\">Export Holdings</Button>\n        { !error && !message && <><br/><Typography color=\"textSecondary\" variant=\"body2\">NOTE: Importing holdings will completely and irreversibly replace any data currently entered</Typography></> }\n        { error && <><br/><Typography color=\"error\" variant=\"body2\">{error}</Typography></> }\n        { message && <><br/><Typography color=\"textSecondary\" variant=\"body2\">{message}</Typography></> }\n    </>;\n}","import React, { useEffect, useMemo, useState, useCallback, Fragment } from 'react';\nimport {\n    TableContainer,\n    Paper,\n    Table,\n    TableHead,\n    TableRow,\n    TableCell,\n    TableBody,\n    IconButton,\n    TextField,\n    MenuItem,\n    Checkbox,\n    ListItemText,\n    Typography,\n    Tooltip\n} from '@material-ui/core';\nimport {\n    Delete,\n    Add,\n    Done,\n    Clear,\n    Edit,\n    Warning,\n    ExpandLess,\n    ExpandMore\n} from '@material-ui/icons';\nimport { KeyboardDatePicker } from \"@material-ui/pickers\";\nimport dayjs from 'dayjs';\nimport Select from './select';\nimport { useSharedState } from '../hooks/useSharedState';\nimport useAllEventsOrdered from '../hooks/useAllEventsOrdered';\nimport useAvailableParcels, { processEvent, getAvailableParcelsLookup } from '../hooks/useAvailableParcels';\nimport { sales as sharedStateSales } from '../sharedState';\nimport { orderBy } from 'lodash-es';\nimport { v4 as uuidv4 } from 'uuid';\n\nfunction applyCgtDiscount(saleDate, parcelDate, cgtLiability) {\n    if(cgtLiability > 0 && dayjs(saleDate).diff(dayjs(parcelDate), 'year', true) > 1)\n        cgtLiability /= 2;\n    return cgtLiability;\n}\n\nfunction calculateCgtLiability(sale) {\n    let cgtLiability = 0;\n    let totalUnitsSold = 0;\n    for(const parcel of sale.applicableParcels) {\n        totalUnitsSold += parcel.unitsSold;\n    }\n    for(const parcel of sale.applicableParcels) {\n        let parcelLiability = (sale.unitPrice * parcel.unitsSold);\n        parcelLiability -= parcel.unitsSold * parcel.perUnitCostBase;\n        parcelLiability -= sale.brokerage * (parcel.unitsSold / totalUnitsSold);\n        cgtLiability += applyCgtDiscount(sale.date, parcel.date, parcelLiability);\n    }\n    return cgtLiability;\n}\n\nexport default function SaleList() {\n    const [sales, setSales] = useSharedState(sharedStateSales);\n    const allEventsOrdered = useAllEventsOrdered();\n    const { orderedSales, saleDataLookup } = useMemo(() => {\n        const ordered = [];\n        const lookup = {};\n        const currentHoldings = {};\n        for(const event of allEventsOrdered) {\n            if(event.type === 'SALE') {\n                const decorations = { errors: [], applicableParcels: [] };\n                for(const parcel of event.applicableParcels) {\n                    const currentParcel = currentHoldings[parcel.id];\n                    if(!currentParcel)\n                        decorations.errors.push(`Parcel ${parcel.id} did not exist at the sale date`);\n                    else if(currentParcel.asxCode !== event.asxCode)\n                        decorations.errors.push(`Parcel ${parcel.id} has the wrong ASX Code`);\n                    else if(currentParcel.remainingUnits < parcel.unitsSold)\n                        decorations.errors.push(`Parcel ${parcel.id} does not have enough remaining units to complete sale`);\n                    decorations.applicableParcels.push({ ...parcel, unitsAvailable: currentParcel?.remainingUnits ?? '??' });\n                }\n                decorations.cgtLiability = decorations.errors.length ? null : calculateCgtLiability({\n                    unitPrice: event.unitPrice,\n                    date: event.date,\n                    brokerage: event.brokerage,\n                    applicableParcels: decorations.applicableParcels.map(p => ({\n                        date: currentHoldings[p.id].date,\n                        perUnitCostBase: currentHoldings[p.id].perUnitCostBase,\n                        unitsSold: p.unitsSold\n                    }))\n                });\n                ordered.push(event);\n                lookup[event.id] = decorations;\n            }\n            processEvent(event, currentHoldings, /*errorOnMissingParcel:*/false);\n        }\n        return { orderedSales: ordered, saleDataLookup: lookup };\n    }, [allEventsOrdered]);\n\n    const [newSaleActive, setNewSaleActive] = useState(false);\n    const saveNewSale = s => {\n        setSales([...sales, s]);\n        setNewSaleActive(false);\n    }\n\n    const lastRow = newSaleActive ?\n        <EditSaleRow cancel={() => setNewSaleActive(false)} save={saveNewSale} allEventsOrdered={allEventsOrdered}/> : \n        <TableRow>\n            <TableCell align=\"right\" colSpan={9}><IconButton onClick={() => setNewSaleActive(true)}><Add/></IconButton></TableCell>\n        </TableRow>\n\n    const [saleIdsBeingEdited, setSaleIdsBeingEdited] = useState([]);\n    const editSale = id => setSaleIdsBeingEdited([...saleIdsBeingEdited, id]);\n    const stopEditingSale = id => setSaleIdsBeingEdited(saleIdsBeingEdited.filter(id2 => id2 !== id));\n    const saveSale = s => {\n        setSales([...sales.filter(s2 => s2.id !== s.id), s]);\n        stopEditingSale(s.id);\n    };\n\n    const [detailSaleIds, setDetailSaleIds] = useState([]);\n    const toggleDetails = saleId => detailSaleIds.includes(saleId) ?\n        setDetailSaleIds(detailSaleIds.filter(id => id !== saleId)) :\n        setDetailSaleIds([...detailSaleIds, saleId]);\n\n    return <TableContainer component={Paper}>\n        <Table style={{ minWidth: 650 }} size=\"small\">\n            <TableHead>\n                <TableRow>\n                    <TableCell/>\n                    <TableCell align=\"right\">Date</TableCell>\n                    <TableCell align=\"right\">ASX Code</TableCell>\n                    <TableCell align=\"right\">Applicable Parcels</TableCell>\n                    <TableCell align=\"right\">Memo</TableCell>\n                    <TableCell align=\"right\">Unit Price ($/u)</TableCell>\n                    <TableCell align=\"right\">Brokerage ($)</TableCell>\n                    <TableCell align=\"right\"><Typography variant=\"body2\" color=\"primary\">CGT Liability ($)</Typography></TableCell>\n                    <TableCell align=\"right\">Actions</TableCell>\n                </TableRow>\n            </TableHead>\n            <TableBody>\n                {orderedSales.map(s => saleIdsBeingEdited.includes(s.id) ?\n                    <EditSaleRow key={s.id} id={s.id} sale={s} cancel={() => stopEditingSale(s.id)} save={saveSale} allEventsOrdered={allEventsOrdered}/> :\n                    <Fragment key={s.id}>\n                        <TableRow key={s.id}>\n                            <TableCell>{ saleDataLookup[s.id].errors.length ?\n                                saleDataLookup[s.id].errors.map(e => <Tooltip key={e} title={e}>\n                                    <Warning color=\"error\"/>\n                                </Tooltip>) :\n                                <></> }</TableCell>\n                            <TableCell align=\"right\">{dayjs(s.date).format('YYYY-MM-DD')}</TableCell>\n                            <TableCell align=\"right\">{s.asxCode}</TableCell>\n                            <TableCell align=\"right\">{saleDataLookup[s.id].applicableParcels.map(p => `${p.id} (${p.unitsSold}/${p.unitsAvailable})`).join(', ')}</TableCell>\n                            <TableCell align=\"right\">{s.memo}</TableCell>\n                            <TableCell align=\"right\">{s.unitPrice}</TableCell>\n                            <TableCell align=\"right\">{s.brokerage}</TableCell>\n                            <TableCell align=\"right\"><Typography variant=\"body2\" color=\"primary\">{saleDataLookup[s.id].cgtLiability?.toFixed(4) ?? '??'}</Typography></TableCell>\n                            <TableCell align=\"right\">\n                                <IconButton size=\"small\" onClick={() => toggleDetails(s.id)}>{detailSaleIds.includes(s.id) ? <ExpandLess/> : <ExpandMore/>}</IconButton>\n                                <IconButton size=\"small\" onClick={() => editSale(s.id)}><Edit/></IconButton>\n                                <IconButton size=\"small\" onClick={() => setSales(sales.filter(s2 => s2.id !== s.id))}><Delete/></IconButton>\n                            </TableCell>\n                        </TableRow>\n                        {detailSaleIds.includes(s.id) && <SaleDetailRow sale={s}/>}\n                    </Fragment>\n                )}\n                {lastRow}\n            </TableBody>\n        </Table>\n    </TableContainer>\n}\n\nfunction SaleDetailRow(props) {\n    const { sale } = props;\n\n    const allEventsOrdered = useAllEventsOrdered();\n    const log = useMemo(() => {\n        const available = getAvailableParcelsLookup(allEventsOrdered, sale.date, /*errorOnMisingParcel:*/false, sale.id );\n        const log = [];\n\n        let totalUnitsSold = 0;\n        for(const applicableParcel of sale.applicableParcels) {\n            const parcel = available[applicableParcel.id];\n            if(!parcel || parcel.asxCode !== sale.asxCode || applicableParcel.unitsSold > parcel.remainingUnits) continue;\n            totalUnitsSold += applicableParcel.unitsSold;\n        }\n        log.push(`Sale applies to a total of ${totalUnitsSold} units.`);\n        for(const applicableParcel of sale.applicableParcels) {\n            const parcel = available[applicableParcel.id];\n            if(!parcel || parcel.asxCode !== sale.asxCode || applicableParcel.unitsSold > parcel.remainingUnits) continue;\n            let message = `${applicableParcel.unitsSold}x ${parcel.id} ($${parcel.perUnitCostBase.toFixed(4)}/u CB): `;\n            const percentage = applicableParcel.unitsSold / totalUnitsSold * 100;\n            const finalCostBase = parcel.perUnitCostBase + sale.brokerage / totalUnitsSold;\n            message += `${percentage.toFixed(2)}% of brokerage added to CB at sale date. Final CB $${finalCostBase.toFixed(4)}/u. `;\n            let capitalGains = (sale.unitPrice - finalCostBase) * applicableParcel.unitsSold;\n            message += `Total capital gains: $${capitalGains.toFixed(2)}`;\n            if(dayjs(sale.date).diff(dayjs(parcel.date), 'year', true) > 1) {\n                capitalGains /= 2;\n                message += `, discounted by 50% since parcel was >1yr old`;\n            }\n            message +=`. Final CGT Liability: $${capitalGains.toFixed(2)}.`;\n            log.push(message);\n        }\n        return log;\n    }, [allEventsOrdered, sale]);\n\n    return <>\n        {log.map(e => <TableRow key={e}>\n            <TableCell/>\n            <TableCell colSpan={7} align=\"right\"><Typography variant=\"body2\" color=\"primary\">\n                {e}\n            </Typography></TableCell>\n            <TableCell/>\n        </TableRow>)}\n    </>\n}\n\nfunction EditSaleRow(props) {\n    const {\n        id,\n        save,\n        cancel,\n        sale,\n        allEventsOrdered\n    } = props;\n\n    const [date, setDate] = useState(null);\n    const [asxCode, setAsxCode] = useState('');\n    const [applicableParcelIds, setApplicableParcelIds] = useState([]);\n    const [memo, setMemo] = useState('');\n    const [unitPrice, setUnitPrice] = useState('');\n    const [brokerage, setBrokerage] = useState('');\n    // Lookup from parcel ID to units sold (string) as input by user\n    const [unitsSoldLookup, setUnitsSoldLookup] = useState({});\n\n    useEffect(() => {\n        setDate(sale?.date ?? null);\n        setAsxCode(sale?.asxCode ?? '');\n        setApplicableParcelIds(sale?.applicableParcels.map(p => p.id) ?? []);\n        setMemo(sale?.memo ?? '');\n        setUnitPrice(sale?.unitPrice.toString() ?? '');\n        setBrokerage(sale?.brokerage.toString() ?? '');\n        const newUnitsSoldLookup = {};\n        for(const parcel of sale?.applicableParcels ?? []) {\n            newUnitsSoldLookup[parcel.id] = parcel.unitsSold.toString();\n        }\n        setUnitsSoldLookup(newUnitsSoldLookup);\n    }, [sale]);\n\n    const allAvailableParcels = useAvailableParcels(\n        allEventsOrdered, date, /*errorOnMissingParcel:*/false, /*eventIdToExclude:*/id);\n    const availableParcels = useMemo(() => {\n        if(asxCode) return allAvailableParcels.filter(p => p.asxCode === asxCode)\n        else return allAvailableParcels;\n    }, [allAvailableParcels, asxCode]);\n\n    const availableParcelsLookup = useMemo(() => {\n        const lookup = {};\n        for(const parcel of availableParcels) {\n            lookup[parcel.id] = parcel;\n        }\n        return lookup;\n    }, [availableParcels]);\n\n    const unitsSoldValid = !applicableParcelIds.find(pid => !parcelSaleIsValid(availableParcelsLookup[pid], unitsSoldLookup[pid]));\n\n    const boundSave = () => save({\n        id: id ?? uuidv4(),\n        date,\n        asxCode,\n        applicableParcels: applicableParcelIds.map(pid => ({\n            id: pid,\n            unitsSold: parseInt(unitsSoldLookup[pid])\n        })),\n        memo,\n        unitPrice: parseFloat(unitPrice),\n        brokerage: parseFloat(brokerage)\n    });\n\n    const unitPriceValid = unitPrice && !isNaN(parseFloat(unitPrice));\n    const brokerageValid = brokerage && !isNaN(parseFloat(brokerage));\n\n    const valid = date && applicableParcelIds.length && unitPriceValid && brokerageValid && asxCode\n        && unitsSoldValid;\n\n    const canCalculatePerUnitCgtLiabilities = unitPriceValid && date && unitsSoldValid;\n\n    const perUnitCgtLiabilityLookup = useMemo(() => {\n        const lookup = {};\n        if(!canCalculatePerUnitCgtLiabilities) return {};\n        const floatUnitPrice = parseFloat(unitPrice);\n        for(const parcel of availableParcels) {\n            // Note: Deliberately not including brokerage in this figure since it would create a sort of\n            // chicken and egg situation where parcels are chosen by per-unit CGT liability, but this\n            // depends on the per-unit brokerage, which depends on the total number of parcels chosen\n            let liability = floatUnitPrice - parcel.perUnitCostBase;\n            lookup[parcel.id] = applyCgtDiscount(date, parcel.date, liability);\n        }\n        return lookup;\n    }, [unitPrice, date, availableParcels, canCalculatePerUnitCgtLiabilities]);\n\n    const orderedAvailableParcels = useMemo(() =>\n        orderBy(availableParcels, p => perUnitCgtLiabilityLookup[p.id]),\n    [availableParcels, perUnitCgtLiabilityLookup]);\n\n    let cgtLiability = null;\n    if(canCalculatePerUnitCgtLiabilities && brokerageValid) {\n        const args = {\n            unitPrice: parseFloat(unitPrice),\n            date,\n            brokerage: parseFloat(brokerage),\n            applicableParcels: applicableParcelIds.map(pid => ({\n                date: availableParcelsLookup[pid].date,\n                perUnitCostBase: availableParcelsLookup[pid].perUnitCostBase,\n                unitsSold: parseInt(unitsSoldLookup[pid])\n            }))\n        };\n        cgtLiability = calculateCgtLiability(args);\n    }\n\n    const rebuildUnitsSoldLookup = useCallback(newApplicableParcelIds => {\n        setUnitsSoldLookup(unitsSoldLookup => {\n            const newUnitsSoldLookup = {};\n            for(const parcelId of newApplicableParcelIds) {\n                newUnitsSoldLookup[parcelId] = unitsSoldLookup[parcelId] ?? availableParcelsLookup[parcelId].remainingUnits;\n            }\n            return newUnitsSoldLookup;\n        });\n    }, [availableParcelsLookup]);\n\n    useEffect(() => {\n        setApplicableParcelIds(ids => {\n            const newApplicableParcelIds = ids.filter(pid => orderedAvailableParcels.find(p => p.id === pid));\n            rebuildUnitsSoldLookup(newApplicableParcelIds);\n            return newApplicableParcelIds;\n        });\n    }, [orderedAvailableParcels, rebuildUnitsSoldLookup]);\n\n    const updateApplicableParcels = newApplicableParcelIds => {\n        setApplicableParcelIds(newApplicableParcelIds);\n        rebuildUnitsSoldLookup(newApplicableParcelIds);\n    }\n\n    const updateUnitsSold = (parcelId, newUnitsSold) => {\n        const newUnitsSoldLookup = { ...unitsSoldLookup };\n        newUnitsSoldLookup[parcelId] = newUnitsSold;\n        setUnitsSoldLookup(newUnitsSoldLookup);\n    }\n\n    return <>\n        <TableRow>\n            <TableCell/>\n            <TableCell align=\"right\">\n                <KeyboardDatePicker\n                    disableToolbar\n                    variant=\"inline\"\n                    format=\"YYYY-MM-DD\"\n                    label=\"Date\"\n                    value={date}\n                    error={!date}\n                    onChange={e => setDate(e.toJSON())}\n                />\n            </TableCell>\n            <TableCell align=\"right\">\n                <TextField value={asxCode} onChange={e => setAsxCode(e.target.value)} label=\"ASX Code\" error={!asxCode}/>\n            </TableCell>\n            <TableCell align=\"right\">\n                <Select\n                    disabled={!date || !orderedAvailableParcels.length || !asxCode}\n                    labelId=\"applicable-parcel-select\"\n                    label=\"Applicable Parcels\"\n                    error={!applicableParcelIds.length}\n                    multiple\n                    fullWidth\n                    value={applicableParcelIds}\n                    onChange={e => updateApplicableParcels(e.target.value)}\n                    renderValue={selected => selected.map(s => s).join(', ')}>\n                    {orderedAvailableParcels.map(p =>\n                        <MenuItem key={p.id} value={p.id}>\n                            <Checkbox color=\"primary\" checked={!!applicableParcelIds.includes(p.id)} />\n                            <ListItemText primary={`${p.id}${p.memo ? ': ' + p.memo : ''}`} secondary={`${p.remainingUnits} available, $${perUnitCgtLiabilityLookup[p.id]?.toFixed(4) ?? '??'}/u CGT`}/>\n                        </MenuItem>)}\n                </Select>\n            </TableCell>\n            <TableCell align=\"right\">\n                <TextField value={memo} onChange={e => setMemo(e.target.value)} label=\"Memo\"/>\n            </TableCell>\n            <TableCell align=\"right\">\n                <TextField type=\"number\" value={unitPrice} onChange={e => setUnitPrice(e.target.value)} error={!unitPriceValid} label=\"Unit Price ($/u)\"/>\n            </TableCell>\n            <TableCell align=\"right\">\n                <TextField type=\"number\" value={brokerage} onChange={e => setBrokerage(e.target.value)} error={!brokerageValid} label=\"Brokerage ($)\"/>\n            </TableCell>\n            <TableCell align=\"right\">\n                <Typography variant=\"body2\" color=\"primary\">Total: {cgtLiability?.toFixed(4) ?? '??'}</Typography>\n            </TableCell>\n            <TableCell align=\"right\" rowSpan={applicableParcelIds.length + 1}>\n                <IconButton onClick={boundSave} disabled={!valid}><Done/></IconButton>\n                <IconButton onClick={cancel}><Clear/></IconButton>\n            </TableCell>\n        </TableRow>\n        {applicableParcelIds.map(pid => \n            <ApplicableParcel\n                key={pid}\n                parcel={availableParcelsLookup[pid]}\n                perUnitCgtLiability={perUnitCgtLiabilityLookup[pid]}\n                unitsSold={unitsSoldLookup[pid]}\n                setUnitsSold={u => updateUnitsSold(pid, u)}/>\n        )}\n    </>;\n}\n\nfunction parcelSaleIsValid(parcel, unitsSold) {\n    if(!unitsSold) return false;\n    const soldFloat = parseFloat(unitsSold);\n    if(isNaN(soldFloat)) return false;\n    const soldInt = parseInt(unitsSold);\n    if(soldInt !== soldFloat) return false;\n    if(soldInt > (parcel?.remainingUnits ?? 0)) return false;\n    if(soldInt <= 0) return false;\n    return true;\n}\n\nfunction ApplicableParcel(props) {\n    const {\n        parcel,\n        perUnitCgtLiability,\n        unitsSold,\n        setUnitsSold\n    } = props;\n\n    const saleValid = parcelSaleIsValid(parcel, unitsSold);\n    const cgtLiability = (perUnitCgtLiability !== undefined && saleValid) ?\n        (perUnitCgtLiability * parseInt(unitsSold)).toFixed(4) : '??';\n\n    return <TableRow>\n        <TableCell/>\n        <TableCell/>\n        <TableCell/>\n        <TableCell align=\"right\">\n            <TextField\n                type=\"number\"\n                value={unitsSold}\n                onChange={e => setUnitsSold(e.target.value)}\n                error={!saleValid}\n                label={`Units of ${parcel?.id ?? '??'}`}\n                helperText={`${parcel?.remainingUnits ?? '??'} available`}/>\n        </TableCell>\n        <TableCell/>\n        <TableCell/>\n        <TableCell/>\n        <TableCell align=\"right\">\n            <Typography variant=\"body2\" color=\"primary\">{parcel?.id ?? '??'}: {cgtLiability}</Typography>\n        </TableCell>\n    </TableRow>\n}","import React from 'react';\n\nexport default function DonateButton() {\n    return <form action=\"https://www.paypal.com/donate\" method=\"post\" target=\"_top\">\n        <input type=\"hidden\" name=\"business\" value=\"VT6UPHJXTK3N2\" />\n        <input type=\"hidden\" name=\"no_recurring\" value=\"1\" />\n        <input type=\"hidden\" name=\"item_name\" value=\"CGT Calculator Thankyou\" />\n        <input type=\"hidden\" name=\"currency_code\" value=\"AUD\" />\n        <input type=\"image\" src=\"https://www.paypalobjects.com/en_AU/i/btn/btn_donate_LG.gif\" border=\"0\" name=\"submit\" title=\"PayPal - The safer, easier way to pay online!\" alt=\"Donate with PayPal button\" />\n        <img alt=\"\" border=\"0\" src=\"https://www.paypal.com/en_AU/i/scr/pixel.gif\" width=\"1\" height=\"1\" />\n    </form>;\n}","import React from 'react';\nimport { Container, Typography } from '@material-ui/core';\nimport ParcelList from './components/parcelList';\nimport AdjustmentList from './components/adjustmentList';\nimport ImportExport from './components/importExport'\nimport SaleList from './components/saleList';\nimport DonateButton from './components/donateButton';\n\nfunction App() {\n    const repoUrl = 'https://github.com/judilsteve/asx-cgt-calculator-optimiser';\n    return (<Container maxWidth=\"xl\">\n        <br/>\n        <Typography variant=\"h2\">ASX CGT Calculator/Optimiser</Typography>\n        <br/>\n        <Typography variant=\"h6\">\n            This is a simple calculator that helps with record-keeping for your ASX holdings,\n            and calculation of CGT when selling.\n            <br/><br/>\n            All care has been taken to ensure that the calculations made here are correct and that they\n            conform to ATO requirements (as at 2021-07-10). I trust this calculator enough to use it for record-keeping\n            and CGT calculations of my own portfolio. However, I make no guarantee that the calculator is free from defects and accept\n            no liability for any consequences incurred by you of issues herein. Always check any values calculated here against\n            your own calculations.\n            <br/><br/>\n            If you find any issues with the calculator, please raise them <a href={`${repoUrl}/issues`}>here</a>.\n            <br/><br/>\n            If you find this calculator useful, and you want to show your appreciation, you can use the donation link below to shout me a coffee.\n            <br/><br/>\n            <DonateButton/>\n            <br/>\n            This calculator is a Single Page Application, or SPA. This means you can save the entire application to your computer\n            right now (press Ctrl+S on your keyboard) so that you still have access to the calculator even if this website\n            disappears from the internet.\n            <br/><br/>\n            This calculator is also free software licensed under the <a href={`${repoUrl}/blob/master/COPYING.md`}>Affero GPL</a>. You may view the source code <a href={repoUrl}>here</a>.\n            If you wish to use the source code as a basis for your own work, you may do so, but you must\n            adhere to the terms of the original license if you distribute your work.\n            <br/><br/>\n            Portfolio data is auto-saved to your browser's local storage: Your data does not leave your computer.\n            It is highly recommended that you export a backup of your portfolio data using the buttons below so that your\n            records are not lost if uninstall your browser, clear the local storage, lose your laptop, etc.\n        </Typography>\n        <br/>\n        <ImportExport/>\n        <br/><br/>\n        <Typography variant=\"h3\">Parcels</Typography>\n        <br/>\n        <Typography variant=\"h6\">\n            Enter details of all holdings (past and present) below, including dividend reinvestments.\n        </Typography>\n        <br/>\n        <ParcelList/>\n        <br/><br/>\n        <Typography variant=\"h3\">Cost Base Adjustments</Typography>\n        <br/>\n        <Typography variant=\"h6\">\n            Enter details of all cost base adjustments below (e.g. AMIT net adjustments from your annual tax statements).\n        </Typography>\n        <br/>\n        <AdjustmentList/>\n        <br/><br/>\n        <Typography variant=\"h3\">Sales</Typography>\n        <br/>\n        <Typography variant=\"h6\">\n            Enter details of all sale events below.\n        </Typography>\n        <br/>\n        <SaleList/>\n        <div style={{ height: '75vh' }}/>{/* Bit of dead space to let the user scroll content up higher for convenience */}\n    </Container>);\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App.jsx';\nimport { MuiPickersUtilsProvider } from '@material-ui/pickers';\nimport DayjsUtils from '@date-io/dayjs';\n\nReactDOM.render(\n  <React.StrictMode>\n    <MuiPickersUtilsProvider utils={DayjsUtils}>\n      <App />\n    </MuiPickersUtilsProvider>\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n"],"sourceRoot":""}